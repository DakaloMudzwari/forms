<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Training Requisition Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <style>
    canvas {
      border: 1px solid #333;
      width: 100%;
      height: 150px;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-4">
    <h2 class="text-center mb-4">Training Requisition Form</h2>
    <form id="trainingForm" class="row g-3">
      <!-- Employee Details -->
      <h5>Employee Details</h5>
      <div class="col-md-6">
        <label class="form-label">Department Name</label>
        <input type="text" class="form-control" name="DepartmentName" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Employee Name</label>
        <input type="text" class="form-control" name="EmployeeName" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Post Title</label>
        <input type="text" class="form-control" name="PostTitle">
      </div>
      <div class="col-md-6">
        <label class="form-label">Date Appointed</label>
        <input type="date" class="form-control" name="DateAppointed">
      </div>
      <div class="col-md-6">
        <label class="form-label">Employee Number</label>
        <input type="text" class="form-control" name="EmployeeNumber">
      </div>
      <div class="col-md-6">
        <label class="form-label">Employee Signature</label>
        <div class="d-flex align-items-center gap-2">
          <canvas id="employeeSignature" class="mb-2 flex-grow-1"></canvas>
          <button type="button" class="btn btn-secondary btn-sm" id="clearEmployeeSignatureBtn">Clear</button>
        </div>
        <label class="form-label mt-2">Date</label>
        <input type="date" class="form-control" name="EmployeeSignatureDate">
      </div>

      <!-- Training Information -->
      <h5 class="mt-4">Training Information</h5>
      <div class="col-md-3">
        <label class="form-label">Skills Audit Completed?</label>
        <select class="form-select" name="SkillsAuditCompleted">
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Required in Audit?</label>
        <select class="form-select" name="RequiredInSkillsAudit">
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Facilitated Internally?</label>
        <select class="form-select" name="CanBeFacilitatedInternally">
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Training Budget Available?</label>
        <select class="form-select" name="TrainingBudgetAvailable">
          <option>Yes</option>
          <option>No</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Budget Amount (if any)</label>
        <input type="number" class="form-control" name="BudgetAmount">
      </div>
      <div class="col-md-8">
        <label class="form-label">How will this support performance?</label>
        <textarea class="form-control" name="WorkPerformanceSupport" rows="2"></textarea>
      </div>

      <!-- Course Details -->
      <h5 class="mt-4">Course Details</h5>
      <div class="col-md-4">
        <label class="form-label">Course Name</label>
        <input type="text" class="form-control" name="CourseName">
      </div>
      <div class="col-md-4">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control" name="StartDate">
      </div>
      <div class="col-md-4">
        <label class="form-label">Duration</label>
        <input type="text" class="form-control" name="Duration">
      </div>
      <div class="col-md-6">
        <label class="form-label">Institution</label>
        <input type="text" class="form-control" name="Institution">
      </div>
      <div class="col-md-6">
        <label class="form-label">Training Cost</label>
        <input type="number" class="form-control" name="TrainingCost">
      </div>
      <div class="col-12">
        <label class="form-label">Motivation</label>
        <textarea class="form-control" name="Motivation" rows="2"></textarea>
      </div>

      <!-- Recommendation -->
      <h5 class="mt-4">Recommendation & Signatures</h5>
      <div class="col-md-4">
        <label class="form-label">Recommendation</label>
        <select class="form-select" name="Recommendation">
          <option>Recommended</option>
          <option>Not Recommended</option>
        </select>
      </div>
      <div class="col-md-8">
        <label class="form-label">Recommendation Comments</label>
        <textarea class="form-control" name="RecommendationComments" rows="2"></textarea>
      </div>

      <div class="col-md-6">
        <label class="form-label">Sectional Head Name</label>
        <input type="text" class="form-control" name="SectionalHead">
      </div>
      <div class="col-md-6">
        <label class="form-label">Sectional Head Signature</label>
        <div class="d-flex align-items-center gap-2">
          <canvas id="signature" class="mb-2 flex-grow-1"></canvas>
          <button type="button" class="btn btn-secondary btn-sm" id="clearSectionalHeadSignatureBtn">Clear</button>
        </div>
        <label class="form-label mt-2">Date</label>
        <input type="date" class="form-control" name="SectionalHeadSignatureDate">
      </div>

      <div class="col-md-6">
        <label class="form-label">Senior Manager Signature</label>
        <div class="d-flex align-items-center gap-2">
          <canvas id="seniorManagerSignature" class="mb-2 flex-grow-1"></canvas>
          <button type="button" class="btn btn-secondary btn-sm" id="clearSeniorManagerSignatureBtn">Clear</button>
        </div>
        <label class="form-label mt-2">Date</label>
        <input type="date" class="form-control" name="SeniorManagerSignatureDate">
      </div>

      <div class="col-md-6">
        <label class="form-label">HOD Signature</label>
        <div class="d-flex align-items-center gap-2">
          <canvas id="hodSignature" class="mb-2 flex-grow-1"></canvas>
          <button type="button" class="btn btn-secondary btn-sm" id="clearHodSignatureBtn">Clear</button>
        
        </div>
        <label class="form-label mt-2">Date</label>
        <input type="date" class="form-control" name="HODSignatureDate">
      </div>

      <div class="col-12">
        <label class="form-label">Upload Supporting Documents (PDF, up to 5)</label>
        <input type="file" id="attachment" class="form-control" accept="application/pdf" multiple>
        <ul id="fileList" class="list-group mt-2"></ul>
      </div>

      <div class="col-md-6">
        <label class="form-label">HR Comments</label>
        <textarea class="form-control" name="HRComments" rows="2"></textarea>
      </div>
      <div class="col-md-4">
        <label class="form-label">Final Date</label>
        <input type="date" class="form-control" name="FinalDate">
      </div>

      <div class="col-12 text-center mt-4">
        <button type="submit" class="btn btn-primary">Submit Form</button>
      </div>
    </form>
  </div>

  <script>
    const signaturePad = new SignaturePad(document.getElementById('signature'));
    const seniorManagerPad = new SignaturePad(document.getElementById('seniorManagerSignature'));
    const hodSignaturePad = new SignaturePad(document.getElementById('hodSignature'));
    const employeeSignaturePad = new SignaturePad(document.getElementById('employeeSignature'));

    document.getElementById('clearSectionalHeadSignatureBtn').onclick = () => signaturePad.clear();
    document.getElementById('clearSeniorManagerSignatureBtn').onclick = () => seniorManagerPad.clear();
    document.getElementById('clearHodSignatureBtn').onclick = () => hodSignaturePad.clear();
    document.getElementById('clearEmployeeSignatureBtn').onclick = () => employeeSignaturePad.clear();

    const fileInput = document.getElementById("attachment");
    const fileList = document.getElementById("fileList");
    let selectedFiles = [];

    function clearSig() {
      signaturePad.clear();
      seniorManagerPad.clear();
      hodSignaturePad.clear();
      employeeSignaturePad.clear();
    }

    fileInput.addEventListener("change", function (e) {
      const files = Array.from(e.target.files);
      for (let file of files) {
        if (selectedFiles.length >= 5) {
          alert("Max 5 files allowed.");
          break;
        }
        if (file.type !== "application/pdf") {
          alert("Only PDFs allowed.");
          continue;
        }
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
          selectedFiles.push(file);
        }
      }
      updateFileList();
      fileInput.value = "";
    });

    function updateFileList() {
      fileList.innerHTML = "";
      selectedFiles.forEach((file, idx) => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = file.name;
        const removeBtn = document.createElement("button");
        removeBtn.className = "btn btn-sm btn-danger";
        removeBtn.textContent = "Remove";
        removeBtn.onclick = () => {
          selectedFiles.splice(idx, 1);
          updateFileList();
        };
        li.appendChild(removeBtn);
        fileList.appendChild(li);
      });
    }

    document.getElementById("trainingForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (signaturePad.isEmpty() || hodSignaturePad.isEmpty() || seniorManagerPad.isEmpty() || employeeSignaturePad.isEmpty()) {
        alert("All signatures required.");
        return;
      }
      const formData = new FormData(e.target);
      const payload = {};
      formData.forEach((value, key) => payload[key] = value);
      payload.SectionalHeadSignature = signaturePad.toDataURL();
      payload.SeniorManagerSignature = seniorManagerPad.toDataURL();
      payload.HODSignature = hodSignaturePad.toDataURL();
      payload.EmployeeSignature = employeeSignaturePad.toDataURL();

      const fileToBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const attachments = [];
      for (const file of selectedFiles) {
        attachments.push(await fileToBase64(file));
      }
      payload.attachments = attachments;

      // Replace below with your Power Automate HTTP trigger URL
      const response = await fetch("YOUR_POWER_AUTOMATE_URL", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        alert("Form submitted successfully.");
        e.target.reset();
        clearSig();
        selectedFiles = [];
        updateFileList();
      } else {
        alert("Error submitting form.");
      }
    });
  </script>
</body>

</html>
