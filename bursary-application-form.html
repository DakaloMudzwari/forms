<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bursary Application Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .step { display: none; }
    .step.active { display: block; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">UNDERGRADUATE BURSARY APPLICATION FORM 2024</h2>
    <form id="burs
    aryForm">
      <!-- Step 1: Personal Details -->
      <div class="step active" id="step-1">
        <h5>Step 1: Personal Details</h5>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">Title</label><input type="text" class="form-control" name="title"></div>
          <div class="col-md-4"><label class="form-label">Surname</label><input type="text" class="form-control" name="surname" required></div>
          <div class="col-md-4"><label class="form-label">Full Name(s)</label><input type="text" class="form-control" name="fullname" required></div>
          <div class="col-md-6"><label class="form-label">ID Number</label><input type="text" class="form-control" name="idNumber" required></div>
          <div class="col-md-3"><label class="form-label">Gender</label><select class="form-select" name="gender"><option>Male</option><option>Female</option></select></div>
          <div class="col-md-3"><label class="form-label">Race</label><select class="form-select" name="race"><option>Black</option><option>White</option><option>Coloured</option><option>Indian</option></select></div>
          <div class="col-md-6"><label class="form-label">Nationality</label><input type="text" class="form-control" name="nationality"></div>
          <div class="col-md-3"><label class="form-label">Disability</label><select class="form-select" name="disability"><option>No</option><option>Yes</option></select></div>
          <div class="col-md-3"><label class="form-label">Home Language</label><input type="text" class="form-control" name="homeLanguage"></div>
          <div class="col-12"><label class="form-label">Physical Address</label><input type="text" class="form-control" name="physicalAddress"></div>
          <div class="col-md-6"><label class="form-label">Postal Address</label><input type="text" class="form-control" name="postalAddress"></div>
          <div class="col-md-3"><label class="form-label">Email</label><input type="email" class="form-control" name="email" required></div>
          <div class="col-md-3"><label class="form-label">Cell Number</label><input type="tel" class="form-control" name="cellNumber"></div>
        </div>
      </div>

      <!-- Step 2: Academic Details -->
      <div class="step" id="step-2">
        <h5>Step 2: Academic & Bursary Details</h5>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">University</label><input type="text" class="form-control" name="university"></div>
          <div class="col-md-4"><label class="form-label">Degree/Diploma</label><input type="text" class="form-control" name="courseName"></div>
          <div class="col-md-4"><label class="form-label">Course Duration</label><input type="text" class="form-control" name="courseDuration"></div>
          <div class="col-md-4"><label class="form-label">Academic Year Applying For</label><select class="form-select" name="academicYear"><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
          <div class="col-md-8"><label class="form-label">Do you have a bursary?</label><select class="form-select" name="hasBursary"><option>No</option><option>Yes</option></select></div>
          <div class="col-md-6"><label class="form-label">If yes, name of bursary</label><input type="text" class="form-control" name="bursaryName"></div>
        </div>
      </div>

      <!-- Step 3: Guardian/Parent Details -->
      <div class="step" id="step-3">
        <h5>Step 3: Guardian/Parent Details</h5>
        <div class="row g-3">
          <div class="col-md-4"><label class="form-label">Guardian Full Name</label><input type="text" class="form-control" name="guardianName"></div>
          <div class="col-md-4"><label class="form-label">Relationship</label><select class="form-select" name="guardianRelation"><option>Father</option><option>Mother</option><option>Other</option></select></div>
          <div class="col-md-4"><label class="form-label">Guardian ID Number</label><input type="text" class="form-control" name="guardianId"></div>
          <div class="col-md-4"><label class="form-label">Cell No</label><input type="text" class="form-control" name="guardianCell"></div>
          <div class="col-md-4"><label class="form-label">Email</label><input type="text" class="form-control" name="guardianEmail"></div>
        </div>
      </div>

      <!-- Step 4: Documents -->
      <div class="step" id="step-4">
        <h5>Step 4: Upload Documents & Declaration</h5>
        <div class="mb-3">
          <label class="form-label">Upload Documents (PDFs only, max 5)</label>
          <input type="file" class="form-control" id="attachments" accept="application/pdf" multiple>
        </div>
        <div class="mb-3">
          <label class="form-label">Signature</label>
          <canvas id="signature" height="75" style="border:1px solid #ccc; width:100%; display:block;"></canvas>
          <button type="button" class="btn btn-secondary btn-sm mt-2" id="clearSignatureBtn">Clear Signature</button>
        </div>
        <p>I certify that the above information is true and correct.</p>
      </div>

      <!-- Navigation Buttons -->
      <div class="mt-4 d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" id="prevBtn">Previous</button>
        <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
        <button type="submit" class="btn btn-success d-none" id="submitBtn">Submit</button>
      </div>
    </form>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <script>
    const steps = document.querySelectorAll('.step');
    let currentStep = 0;
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");
    const submitBtn = document.getElementById("submitBtn");
    let signaturePad;

    function showStep(step) {
      steps.forEach((el, i) => el.classList.toggle('active', i === step));
      prevBtn.style.display = step === 0 ? "none" : "inline-block";
      nextBtn.classList.toggle('d-none', step === steps.length - 1);
      submitBtn.classList.toggle('d-none', step !== steps.length - 1);
    }

    nextBtn.addEventListener("click", () => {
      if (currentStep < steps.length - 1) currentStep++;
      showStep(currentStep);
    });

    prevBtn.addEventListener("click", () => {
      if (currentStep > 0) currentStep--;
      showStep(currentStep);
    });

    document.getElementById("bursaryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (signaturePad.isEmpty()) return alert("Please sign before submitting.");

      const form = e.target;
      const formData = new FormData(form);
      const payload = {};
      formData.forEach((v, k) => payload[k] = v);
      payload.signature = signaturePad.toDataURL();

      const files = document.getElementById('attachments').files;
      if (files.length === 0) return alert("Please upload required documents.");

      const filePromises = Array.from(files).slice(0, 5).map(file => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve({ name: file.name, content: reader.result.split(",")[1] });
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      });

      payload.attachments = await Promise.all(filePromises);

      try {
        const response = await fetch('YOUR_POWER_AUTOMATE_URL', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (response.ok) {
          alert("Application submitted!");
          form.reset();
          signaturePad.clear();
        } else {
          alert("Submission failed.");
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    function resizeSignatureCanvas(restoreData) {
      const canvas = document.getElementById('signature');
      const ratio = window.devicePixelRatio || 1;
      // Match the canvas's width to its displayed width
      const width = canvas.offsetWidth;
      canvas.width = width * ratio;
      canvas.height = 150 * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      if (signaturePad && restoreData) {
        signaturePad.fromData(restoreData);
      }
    }

    // Initial resize before creating SignaturePad
    resizeSignatureCanvas();

    // Now create the SignaturePad instance
    signaturePad = new SignaturePad(document.getElementById('signature'));

    // On window resize, save and restore signature
    window.addEventListener('resize', () => {
      const data = signaturePad.toData();
      resizeSignatureCanvas(data);
      signaturePad.clear();
      if (data && data.length) {
        signaturePad.fromData(data);
      }
    });

    // Clear button handler
    document.getElementById('clearSignatureBtn').onclick = () => signaturePad.clear();

    showStep(currentStep);
  </script>
</body>
</html>
